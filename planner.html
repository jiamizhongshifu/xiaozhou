<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œç¨‹è§„åˆ’ - æ—…è¡Œè§„åˆ’å¸ˆå°å‘¨</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/nav-menu.css">
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .chat-messages {
            height: calc(100vh - 200px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message {
            display: flex;
            flex-direction: column;
            margin-bottom: 16px;
            max-width: 100%;
        }
        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
        }
        .user-message {
            align-self: flex-end;
        }
        .user-message .message-content {
            background-color: #0071e3;
            color: white;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }
        .bot-message {
            align-self: flex-start;
        }
        .bot-message .message-content {
            background-color: #f2f2f7;
            color: #1c1c1e;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }
        .typing-dots .dot {
            animation-duration: 1.4s;
            animation-iteration-count: infinite;
            animation-fill-mode: both;
        }
        .suggestion-btn {
            white-space: nowrap;
        }
        #suggestion-buttons {
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        #suggestion-buttons::-webkit-scrollbar {
            display: none;
        }
        
        /* è°ƒæ•´èŠå¤©åŒºåŸŸçš„å®šä½ï¼Œé¿å…è¢«å¯¼èˆªæ é®æŒ¡ */
        .h-screen {
            height: calc(100vh - 70px);
            margin-top: 70px;
        }

        .itinerary-container {
            background-color: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin: 15px 0;
            width: 100%;
        }

        .section-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .itinerary-overview {
            background-color: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #0071e3;
        }

        .overview-list {
            margin: 0;
            padding-left: 20px;
            display: flex;
            flex-wrap: wrap;
        }

        .overview-list li {
            margin-bottom: 5px;
            padding-right: 15px;
            width: 50%;
            box-sizing: border-box;
        }

        .overview-list li strong {
            color: #0071e3;
        }

        .itinerary-days {
            padding: 15px;
        }

        /* æ–°å¢ - æ°´å¹³å¡ç‰‡æ»šåŠ¨ */
        .day-cards-container {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            margin: 0 -10px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .day-cards-container::-webkit-scrollbar {
            height: 6px;
        }

        .day-cards-container::-webkit-scrollbar-thumb {
            background-color: rgba(0,113,227,0.5);
            border-radius: 3px;
        }

        .day-cards-container::-webkit-scrollbar-track {
            background-color: #f0f0f0;
            border-radius: 3px;
        }

        /* æ—¥å¡ç‰‡æ ·å¼è°ƒæ•´ä¸ºæ°´å¹³å¸ƒå±€ */
        .day-card {
            background-color: white;
            border-radius: 8px;
            margin: 0 10px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-width: 280px;
            max-width: 280px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            border: 1px solid #e1e4e8;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .day-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .day-title {
            background-color: #0071e3;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-content {
            padding: 12px 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* å¼ºè°ƒé‡è¦ä¿¡æ¯ */
        .highlight {
            background-color: #fff8e6;
            border-left: 3px solid #fdbe33;
            padding: 8px 12px;
            margin: 8px 0;
            font-weight: 500;
        }

        .key-info {
            color: #0071e3;
            font-weight: bold;
        }

        .info-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            border-bottom: 2px solid #0071e3;
            padding-bottom: 4px;
            display: inline-block;
        }

        .time-slot {
            font-weight: 600;
            color: #0071e3;
            margin-right: 10px;
            min-width: 50px;
            display: inline-block;
            flex-shrink: 0;
            background-color: #e6f2ff;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .address-info {
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
            background-color: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .tips-info {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #e1e4e8;
            font-style: italic;
            color: #555;
        }

        .tips-info::before {
            content: "ğŸ’¡ ";
        }

        .schedule-list {
            margin: 0;
            padding-left: 5px;
            list-style-type: none;
        }

        .schedule-list li {
            margin-bottom: 12px;
            position: relative;
            display: flex;
            align-items: flex-start;
        }

        .schedule-list li:before {
            content: "â€¢";
            position: absolute;
            left: -10px;
            color: #0071e3;
            font-size: 18px;
        }

        .schedule-item {
            display: flex;
            width: 100%;
        }

        .activity-content {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .activity-main {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .activity-desc {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .activity-text {
            flex: 1;
        }

        .time-paragraph {
            display: flex;
            margin-bottom: 10px;
            align-items: baseline;
        }

        .source-indicator {
            display: inline-flex;
            align-items: center;
            margin-top: 10px;
            padding: 4px 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-size: 0.8em;
            color: #666;
        }

        .source-indicator.deepseek-source {
            background-color: #e6f4ea;
            color: #1e7e34;
        }

        .source-indicator i {
            margin-right: 5px;
        }

        .itinerary-title {
            border-bottom: 2px solid #0071e3;
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: #0071e3;
        }

        .additional-info {
            padding: 15px;
            background-color: #fafafa;
            border-top: 1px solid #e1e4e8;
        }

        .info-section {
            margin-bottom: 15px;
        }

        .info-section:last-child {
            margin-bottom: 0;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .scroll-controls {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            gap: 10px;
        }

        .scroll-button {
            background-color: #0071e3;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .scroll-button:hover {
            background-color: #005bb5;
        }

        .scroll-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* å¢åŠ åˆ†éš”çº¿ */
        .section-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #0071e3, transparent);
            margin: 20px 0;
        }
        
        /* è¡Œç¨‹æ“ä½œæŒ‰é’®æ ·å¼ */
        .itinerary-actions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .share-button, .regenerate-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 15px;
            background-color: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .share-button:hover, .regenerate-button:hover {
            background-color: #e0e0e0;
        }
        
        .share-button i, .regenerate-button i {
            margin-right: 6px;
        }
        
        .regenerate-button {
            background-color: #e6f3ff;
            color: #0071e3;
        }
        
        .regenerate-button:hover {
            background-color: #d0e8ff;
        }

        /* è¡Œç¨‹ç”ŸæˆçŠ¶æ€æ ·å¼ */
        .generating-message {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e9ecef;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            margin-right: 12px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* éªŒè¯æç¤ºæ ·å¼ */
        .validation-note {
            margin-top: 12px;
            padding: 10px;
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            border-radius: 4px;
            font-size: 14px;
            color: #2e7d32;
        }
        
        .validation-note i {
            margin-right: 8px;
        }
        
        /* å†…å®¹è¡¥å…¨æ ·å¼ */
        .completion-highlight {
            background-color: rgba(255, 235, 59, 0.2);
            border-bottom: 1px dashed #ffc107;
            padding: 0 2px;
        }
        
        /* è¡Œç¨‹ç”Ÿæˆè¿›åº¦æŒ‡ç¤ºå™¨CSSè¡¥å…… */
        .itinerary-progress-container {
            animation: slide-in 0.3s ease-out;
        }
        
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* å¢å¼ºå¯è§æ€§å’Œæ­¥éª¤æŒ‡ç¤º */
        .progress-steps::before {
            content: '';
            position: absolute;
            top: 6px;
            left: 10%;
            width: 80%;
            height: 2px;
            background-color: #ddd;
            z-index: 0;
        }
        
        .progress-steps {
            position: relative;
        }
        
        .step-indicator {
            position: relative;
            z-index: 1;
        }
        
        /* åˆ†äº«å’Œé‡æ–°ç”ŸæˆæŒ‰é’®æ ·å¼å¢å¼º */
        .share-button, .regenerate-button {
            transition: transform 0.2s ease;
        }
        
        .share-button:hover, .regenerate-button:hover {
            transform: translateY(-2px);
        }
        
        .share-button:active, .regenerate-button:active {
            transform: translateY(1px);
        }
        
        /* è‡ªåŠ¨è¡¥å…¨ä¿¡æ¯æ ·å¼ */
        .auto-completed-day {
            position: relative;
        }
        
        .auto-completed-day::after {
            content: 'è‡ªåŠ¨è¡¥å……';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 11px;
            background-color: #ffeb3b;
            color: #212121;
            padding: 2px 6px;
            border-radius: 10px;
            opacity: 0.7;
        }

        /* è¡Œç¨‹å±•ç¤ºä¼˜åŒ– - Tabå¯¼èˆªå’ŒæŠ˜å åŠŸèƒ½ */
        
        /* Tabå¯¼èˆªç³»ç»Ÿ */
        .itinerary-tabs {
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .tabs-nav {
            display: flex;
            background: #f5f5f7;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            color: #333;
            transition: all 0.2s;
            position: relative;
        }
        
        .tab-btn:hover {
            background: rgba(0,0,0,0.03);
        }
        
        .tab-btn.active {
            color: #007aff;
            background: #fff;
            border-bottom: 2px solid #007aff;
        }
        
        .tabs-content {
            padding: 20px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* æ—¥æœŸå¯¼èˆªæ ·å¼ */
        .daily-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .day-nav-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: #f8f8f8;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .day-nav-btn:hover {
            background: #f0f0f0;
        }
        
        .day-nav-btn.active {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }
        
        /* æ¯æ—¥å†…å®¹æ ·å¼ */
        .daily-content {
            position: relative;
        }
        
        .day-detail {
            display: none;
            margin-bottom: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .day-detail.active {
            display: block;
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            border-radius: 8px 8px 0 0;
        }
        
        .day-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .day-content-wrapper {
            padding: 0 15px 15px;
        }
        
        /* æ—¶é—´æ®µæ ·å¼ */
        .time-period {
            margin: 15px 0;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .period-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f5f5f7;
            cursor: pointer;
        }
        
        .period-name {
            font-weight: 500;
            color: #333;
        }
        
        .period-details {
            padding: 15px;
            background: #fff;
        }
        
        .period-items {
            margin: 0;
            padding-left: 20px;
        }
        
        .period-items li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .no-content {
            color: #999;
            font-style: italic;
        }
        
        /* å½“æ—¥ä¿¡æ¯åº•éƒ¨ */
        .day-info-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #eee;
        }
        
        .transport-info, .food-info {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .toggle-day-details, .toggle-period-details {
            background: transparent;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .toggle-day-details:hover, .toggle-period-details:hover {
            background: rgba(0,0,0,0.05);
        }
        
        /* å…¶ä»–æ ‡ç­¾é¡µå†…å®¹æ ·å¼ */
        .accommodations-content, .food-content, .tips-content {
            margin-bottom: 20px;
        }
        
        .section-title {
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        
        .acc-list, .food-list, .tips-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .acc-item, .food-item, .tip-item {
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* æ´»åŠ¨è¯¦æƒ…å†…å®¹ */
        .activity-details {
            margin-top: 8px;
            padding-left: 10px;
            border-left: 2px solid #eee;
        }
        
        .detail-item {
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }
        
        .activity-main {
            font-weight: 500;
            color: #333;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .tabs-nav {
                flex-wrap: nowrap;
            }
            
            .tab-btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .tabs-content {
                padding: 15px;
            }
            
            .day-header {
                padding: 12px 15px;
            }
            
            .day-header h3 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- å¯¼èˆªæ å°†ç”± JavaScript åŠ¨æ€æ·»åŠ  -->

    <div class="h-screen flex">
        <!-- èŠå¤©åŒºåŸŸ -->
        <div id="chat-container" class="flex-1 flex flex-col bg-gray-50 relative">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div class="chat-header">
                <h1>ä¸æ—…è¡Œè§„åˆ’å¸ˆå°å‘¨å¯¹è¯</h1>
                <p>å‘Šè¯‰æˆ‘ä½ çš„æ—…è¡Œéœ€æ±‚ï¼Œæˆ‘ä¼šä¸ºä½ å®šåˆ¶å®Œç¾è¡Œç¨‹</p>
                
                <!-- å¤´éƒ¨æ“ä½œæŒ‰é’® -->
                <div class="absolute right-4 top-4 flex items-center gap-2">
                    <!-- APIæµ‹è¯•æŒ‰é’® -->
                    <button id="test-api" class="chat-action-button" title="æµ‹è¯•APIè¿æ¥">
                        <i class="fas fa-plug"></i>
                    </button>
                    <button id="clear-chat" class="chat-action-button" title="æ¸…é™¤èŠå¤©è®°å½•">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div class="chat-messages">
                <!-- æ¶ˆæ¯å†…å®¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                <div class="date-separator">
                    <span class="date-text">ä»Šå¤©</span>
                </div>
            </div>
            
            <!-- å»ºè®®æŒ‰é’®åŒºåŸŸ -->
            <div class="suggestion-container">
                <div id="suggestion-buttons" class="flex space-x-2 overflow-x-auto">
                    <!-- å»ºè®®æŒ‰é’®ä¼šåœ¨JSä¸­åŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
            
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="chat-input-container">
                <!-- é™„åŠ åŠŸèƒ½æŒ‰é’® -->
                <div class="chat-extra-actions">
                    <button class="chat-action-button" id="upload-button" title="ä¸Šä¼ å›¾ç‰‡">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="chat-action-button" id="location-button" title="åˆ†äº«ä½ç½®">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                    <button class="chat-action-button" id="voice-button" title="è¯­éŸ³è¾“å…¥">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                
                <div class="chat-input-wrapper">
                    <input id="message-input" type="text" placeholder="è¾“å…¥ä½ çš„æ—…è¡Œéœ€æ±‚ã€é—®é¢˜æˆ–ç›®çš„åœ°..." class="flex-1">
                    <button id="send-button" aria-label="å‘é€æ¶ˆæ¯">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <p class="chat-input-hint">ä¾‹å¦‚ï¼š"å¸®æˆ‘è§„åˆ’ä¸€æ¬¡æ—¥æœ¬7å¤©ä¹‹æ—…" æˆ– "æ¨èé€‚åˆ12æœˆä»½å»çš„ç›®çš„åœ°"</p>
            </div>
        </div>
    </div>

    <!-- åˆ†äº«èœå• Modal -->
    <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-xl p-5 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">åˆ†äº«æ—…è¡Œè®¡åˆ’</h3>
                <button id="close-share-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <button class="flex flex-col items-center p-3 hover:bg-gray-100 rounded-lg">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white mb-2">
                        <i class="fab fa-weixin text-lg"></i>
                    </div>
                    <span class="text-xs">å¾®ä¿¡</span>
                </button>
                <button class="flex flex-col items-center p-3 hover:bg-gray-100 rounded-lg">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white mb-2">
                        <i class="far fa-envelope text-lg"></i>
                    </div>
                    <span class="text-xs">é‚®ä»¶</span>
                </button>
                <button class="flex flex-col items-center p-3 hover:bg-gray-100 rounded-lg">
                    <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center text-white mb-2">
                        <i class="fas fa-link text-lg"></i>
                    </div>
                    <span class="text-xs">å¤åˆ¶é“¾æ¥</span>
                </button>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium">
                    ä¿å­˜åˆ°æˆ‘çš„è¡Œç¨‹
                </button>
            </div>
        </div>
    </div>
    
    <!-- è¯­éŸ³è¾“å…¥ Modal -->
    <div id="voice-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-xl p-5 max-w-md w-full mx-4 text-center">
            <div class="mb-4">
                <div class="w-20 h-20 bg-blue-100 rounded-full mx-auto flex items-center justify-center">
                    <i id="voice-icon" class="fas fa-microphone text-blue-600 text-3xl"></i>
                </div>
            </div>
            <p id="voice-status" class="mb-3">ç‚¹å‡»å¼€å§‹å½•éŸ³</p>
            <div class="flex justify-center gap-4">
                <button id="start-voice" class="px-4 py-2 bg-blue-600 text-white rounded-lg">
                    å¼€å§‹å½•éŸ³
                </button>
                <button id="stop-voice" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hidden">
                    åœæ­¢å½•éŸ³
                </button>
                <button id="close-voice-modal" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- Core Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½
        if (!window.AppConfig || !window.AppConfig.API_CONFIG) {
            console.error('é…ç½®åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨ç¦»çº¿æ¨¡å¼');
        }
    </script>
    
    <!-- å¼•å…¥æ™ºèƒ½è¡¨å•é¢„å¡«å……æ¨¡å— -->
    <script src="js/modules/context-cache.js"></script>
    <script src="js/modules/conversation-analyzer.js"></script>
    <script src="js/modules/form-prefill-manager.js"></script>
    <script src="js/modules/module-loader.js"></script>
    <script src="js/modules/bootstrap.js"></script>
    <script src="js/modules/form-integration.js"></script>
    
    <!-- Application Scripts -->
    <script src="js/api.js"></script>
    <script src="js/itinerary-validator.js"></script>
    <script src="js/main.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/components/nav-menu.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å¯¼èˆªèœå•ç»„ä»¶
            if (typeof GlobalNavMenu !== 'undefined') {
                console.log('åˆå§‹åŒ–å¯¼èˆªèœå•ç»„ä»¶');
                new GlobalNavMenu();
            }
            
            // åˆå§‹åŒ–èŠå¤©
            console.log('åˆå§‹åŒ–èŠå¤©ç»„ä»¶');
            if (typeof window.initChat === 'function') {
                window.initChat();
            } else if (window.ChatModule && window.ChatModule.initChat) {
                window.ChatModule.initChat();
            } else {
                console.error('èŠå¤©åˆå§‹åŒ–å‡½æ•°æœªæ‰¾åˆ°');
            }
            
            let isFromHomepage = false;
            let initializationAttempts = 0;
            const maxInitAttempts = 20; // æœ€å¤šå°è¯•20æ¬¡
            
            // æ£€æŸ¥æ¨¡å—æ˜¯å¦éƒ½å·²åŠ è½½
            function checkModulesLoaded() {
                return window.AppConfig && 
                       window.AppUtils && 
                       window.TravelAI && 
                       window.ChatModule;
            }
            
            // åˆå§‹åŒ–èŠå¤©æ¨¡å—
            function initChat() {
                console.log('å°è¯•åˆå§‹åŒ–èŠå¤©æ¨¡å—...');
                console.log('æ¨¡å—çŠ¶æ€:', {
                    AppConfig: !!window.AppConfig,
                    AppUtils: !!window.AppUtils,
                    TravelAI: !!window.TravelAI,
                    ChatModule: !!window.ChatModule
                });
                
                initializationAttempts++;
                
                // æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„æ¨¡å—æ˜¯å¦å·²åŠ è½½
                if (!checkModulesLoaded()) {
                    if (initializationAttempts < maxInitAttempts) {
                        console.log(`ç­‰å¾…æ¨¡å—åŠ è½½... (${initializationAttempts}/${maxInitAttempts})`);
                        setTimeout(initChat, 200);
                        return;
                    } else {
                        console.warn('æ¨¡å—åŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
                    }
                }
                
                // é˜²æ­¢é‡å¤åˆå§‹åŒ–
                if (window.isChatInitialized) {
                    console.log('èŠå¤©æ¨¡å—å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                    return;
                }
                
                // åˆå§‹åŒ–èŠå¤©æ¨¡å—
                if (window.ChatModule && typeof window.ChatModule.init === 'function') {
                    console.log('å¼€å§‹åˆå§‹åŒ–èŠå¤©æ¨¡å—');
                    window.ChatModule.init({
                        skipWelcomeMessage: isFromHomepage,
                        useLocalMode: !window.TravelAI
                    });
                    window.isChatInitialized = true;
                    console.log('èŠå¤©æ¨¡å—åˆå§‹åŒ–å®Œæˆ');
                    
                    // å¦‚æœæœ‰URLå‚æ•°ï¼Œå¤„ç†å®ƒ
                    handleUrlParameters();
                } else {
                    console.error('èŠå¤©æ¨¡å—ä¸å¯ç”¨');
                }
            }
            
            // å¤„ç†URLå‚æ•°
            function handleUrlParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const question = urlParams.get('q');
                
                if (question && question.trim()) {
                    console.log('æ”¶åˆ°ä»é¦–é¡µä¼ æ¥çš„é—®é¢˜:', question);
                    isFromHomepage = true;
                    
                    const messageInput = document.getElementById('message-input');
                    if (messageInput) {
                        messageInput.value = decodeURIComponent(question);
                    }
                    
                    // å»¶è¿Ÿå‘é€æ¶ˆæ¯ï¼Œç¡®ä¿æ¨¡å—å·²å®Œå…¨åˆå§‹åŒ–
                    setTimeout(() => {
                        if (window.ChatModule && window.ChatModule.sendMessage) {
                            window.ChatModule.sendMessage();
                        } else {
                            console.error('ChatModule.sendMessage ä¸å¯ç”¨');
                        }
                    }, 1000);
                }
            }
            
            // å¼€å§‹åˆå§‹åŒ–
            initChat();
            
            // æ¨¡æ€æ¡†æ§åˆ¶
            const shareButtons = document.querySelectorAll('.share-button');
            const shareModal = document.getElementById('share-modal');
            const closeShareModal = document.getElementById('close-share-modal');
            
            if (shareButtons.length && shareModal && closeShareModal) {
                shareButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        shareModal.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                    });
                });
                
                closeShareModal.addEventListener('click', function() {
                    shareModal.style.display = 'none';
                    document.body.style.overflow = '';
                });
                
                // ç‚¹å‡»å¼¹çª—å¤–åŒºåŸŸä¹Ÿå¯å…³é—­
                shareModal.addEventListener('click', function(e) {
                    if (e.target === shareModal) {
                        shareModal.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
                
                // æ·»åŠ ESCé”®å…³é—­
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && shareModal.style.display === 'flex') {
                        shareModal.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
            }
            
            // è¯­éŸ³æ¨¡æ€æ¡†æ§åˆ¶
            const voiceButton = document.getElementById('voice-button');
            const voiceModal = document.getElementById('voice-modal');
            const closeVoiceModal = document.getElementById('close-voice-modal');
            const startVoice = document.getElementById('start-voice');
            const stopVoice = document.getElementById('stop-voice');
            const voiceStatus = document.getElementById('voice-status');
            const voiceIcon = document.getElementById('voice-icon');
            
            if (voiceButton && voiceModal && closeVoiceModal) {
                voiceButton.addEventListener('click', function() {
                    voiceModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                });
                
                closeVoiceModal.addEventListener('click', function() {
                    voiceModal.style.display = 'none';
                    document.body.style.overflow = '';
                });
                
                if (startVoice && stopVoice) {
                    startVoice.addEventListener('click', function() {
                        // æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«å¼€å§‹
                        startVoice.classList.add('hidden');
                        stopVoice.classList.remove('hidden');
                        voiceStatus.textContent = 'æ­£åœ¨å½•éŸ³...';
                        voiceIcon.classList.add('text-red-600');
                        
                        // æ¨¡æ‹Ÿæ³¢å½¢åŠ¨ç”»
                        voiceIcon.classList.add('fa-beat');
                    });
                    
                    stopVoice.addEventListener('click', function() {
                        // æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«ç»“æŸ
                        startVoice.classList.remove('hidden');
                        stopVoice.classList.add('hidden');
                        voiceStatus.textContent = 'è¯†åˆ«ä¸­...';
                        voiceIcon.classList.remove('fa-beat');
                        
                        // æ¨¡æ‹Ÿè¯†åˆ«å®Œæˆ
                        setTimeout(() => {
                            voiceModal.style.display = 'none';
                            document.body.style.overflow = '';
                            
                            // æ¨¡æ‹Ÿæ·»åŠ è¯†åˆ«ç»“æœåˆ°è¾“å…¥æ¡†
                            const messageInput = document.getElementById('message-input');
                            if (messageInput) {
                                messageInput.value = 'æˆ‘æƒ³å»æ—¥æœ¬æ—…æ¸¸ï¼Œ7å¤©å·¦å³ï¼Œæƒ³çœ‹æ¨±èŠ±';
                                messageInput.focus();
                            }
                        }, 1500);
                    });
                }
            }
            
            // æ¸…é™¤èŠå¤©è®°å½•
            const clearChat = document.getElementById('clear-chat');
            if (clearChat) {
                clearChat.addEventListener('click', function() {
                    if (confirm('ç¡®è®¤è¦æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
                        const chatMessages = document.querySelector('.chat-messages');
                        if (chatMessages) {
                            // ä¿ç•™æ—¥æœŸåˆ†éš”çº¿
                            const dateSeparator = chatMessages.querySelector('.date-separator');
                            chatMessages.innerHTML = '';
                            if (dateSeparator) {
                                chatMessages.appendChild(dateSeparator);
                            }
                            
                            // é‡ç½®å¯¹è¯å†å²
                            if (window.ChatModule && window.ChatModule.resetConversation) {
                                window.ChatModule.resetConversation();
                            }
                        }
                    }
                });
            }

            // æ·»åŠ APIæµ‹è¯•æŒ‰é’®äº‹ä»¶å¤„ç†
            const testApiBtn = document.getElementById('test-api');
            if (testApiBtn) {
                testApiBtn.addEventListener('click', async function() {
                    try {
                        if (!window.TravelAI || !window.TravelAI.testAPIConnection) {
                            alert('APIæ¨¡å—æœªå°±ç»ªï¼Œæ— æ³•æµ‹è¯•è¿æ¥');
                            return;
                        }
                        
                        testApiBtn.disabled = true;
                        testApiBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        
                        const result = await window.TravelAI.testAPIConnection();
                        
                        if (result.success) {
                            alert('APIè¿æ¥æµ‹è¯•æˆåŠŸï¼');
                        } else {
                            alert(`APIè¿æ¥æµ‹è¯•å¤±è´¥: ${result.message}`);
                        }
                    } catch (error) {
                        console.error('æµ‹è¯•APIè¿æ¥æ—¶å‡ºé”™:', error);
                        alert(`æµ‹è¯•APIè¿æ¥æ—¶å‡ºé”™: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
                    } finally {
                        testApiBtn.disabled = false;
                        testApiBtn.innerHTML = '<i class="fas fa-plug"></i>';
                    }
                });
            }
        });
    </script>

    <!-- è¡Œç¨‹å±•ç¤ºä¼˜åŒ–çš„JavaScriptå‡½æ•° -->
    <script>
        // åˆ‡æ¢æ—¶é—´æ®µè¯¦æƒ…æ˜¾ç¤º/éšè—
        function togglePeriodDetails(element) {
            const details = element.closest('.time-period').querySelector('.period-details');
            const button = element.querySelector('.toggle-period-details');
            const icon = button.querySelector('i');
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                button.setAttribute('aria-expanded', 'true');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                details.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }
        
        // åˆ‡æ¢æ´»åŠ¨è¯¦æƒ…æ˜¾ç¤º/éšè—
        function toggleActivityDetails(element) {
            const details = element.closest('.activity-item').querySelector('.activity-details');
            const button = element.querySelector('.toggle-activity-details');
            const icon = button.querySelector('i');
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                button.setAttribute('aria-expanded', 'true');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                details.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }
        
        // å…¨å±€äº‹ä»¶ç›‘å¬å™¨ï¼Œå¤„ç†åŠ¨æ€æ·»åŠ çš„è¡Œç¨‹å…ƒç´ 
        document.addEventListener('click', function(e) {
            // å¤„ç†Tabåˆ‡æ¢
            if (e.target.classList.contains('tab-btn') || e.target.closest('.tab-btn')) {
                const btn = e.target.classList.contains('tab-btn') ? e.target : e.target.closest('.tab-btn');
                const tabId = 'tab-' + btn.dataset.tab;
                const tabContainer = btn.closest('.itinerary-tabs');
                
                if (tabContainer) {
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    tabContainer.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    tabContainer.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    
                    // è®¾ç½®å½“å‰æ´»åŠ¨Tab
                    btn.classList.add('active');
                    const tabPane = tabContainer.querySelector('#' + tabId);
                    if (tabPane) {
                        tabPane.classList.add('active');
                    }
                }
            }
            
            // å¤„ç†å¤©æ•°å¯¼èˆªåˆ‡æ¢
            if (e.target.classList.contains('day-nav-btn') || e.target.closest('.day-nav-btn')) {
                const btn = e.target.classList.contains('day-nav-btn') ? e.target : e.target.closest('.day-nav-btn');
                const dayNum = btn.dataset.day;
                const dailyContent = btn.closest('.daily-content') || btn.closest('#tab-daily');
                
                if (dailyContent) {
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    dailyContent.querySelectorAll('.day-nav-btn').forEach(b => b.classList.remove('active'));
                    dailyContent.querySelectorAll('.day-detail').forEach(d => d.classList.remove('active'));
                    
                    // è®¾ç½®å½“å‰æ´»åŠ¨å¤©
                    btn.classList.add('active');
                    const dayDetail = dailyContent.querySelector('.day-detail[data-day="' + dayNum + '"]');
                    if (dayDetail) {
                        dayDetail.classList.add('active');
                    }
                }
            }
            
            // å¤„ç†æ—¶é—´æ®µæŠ˜å /å±•å¼€
            if (e.target.classList.contains('period-header') || e.target.closest('.period-header')) {
                const header = e.target.classList.contains('period-header') ? e.target : e.target.closest('.period-header');
                togglePeriodDetails(header);
            }
            
            // å¤„ç†æ´»åŠ¨æŠ˜å /å±•å¼€
            if (e.target.classList.contains('activity-header') || e.target.closest('.activity-header')) {
                const header = e.target.classList.contains('activity-header') ? e.target : e.target.closest('.activity-header');
                toggleActivityDetails(header);
            }
        });
        
        // åœ¨è¡Œç¨‹ç”Ÿæˆååˆå§‹åŒ–UI
        function initItineraryUI() {
            // è·å–æ‰€æœ‰æ—¶é—´æ®µè¯¦æƒ…å¹¶é»˜è®¤æŠ˜å éç¬¬ä¸€ä¸ª
            const timeperiods = document.querySelectorAll('.time-period');
            timeperiods.forEach((period, index) => {
                if (index > 0) { // é»˜è®¤åªå±•å¼€ç¬¬ä¸€ä¸ªæ—¶é—´æ®µ
                    const details = period.querySelector('.period-details');
                    const button = period.querySelector('.toggle-period-details');
                    const icon = button.querySelector('i');
                    
                    if (details && !details.classList.contains('hidden')) {
                        details.classList.add('hidden');
                        button.setAttribute('aria-expanded', 'false');
                        if (icon) {
                            icon.classList.remove('fa-chevron-up');
                            icon.classList.add('fa-chevron-down');
                        }
                    }
                }
            });
            
            // æ‰€æœ‰æ´»åŠ¨é»˜è®¤æŠ˜å 
            const activities = document.querySelectorAll('.activity-details');
            activities.forEach(activity => {
                if (!activity.classList.contains('hidden')) {
                    activity.classList.add('hidden');
                    const button = activity.closest('.activity-item').querySelector('.toggle-activity-details');
                    if (button) {
                        button.setAttribute('aria-expanded', 'false');
                        const icon = button.querySelector('i');
                        if (icon) {
                            icon.classList.remove('fa-chevron-up');
                            icon.classList.add('fa-chevron-down');
                        }
                    }
                }
            });
        }
        
        // ç›‘å¬DOMå˜åŒ–ï¼Œæ£€æµ‹æ–°æ·»åŠ çš„è¡Œç¨‹
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                    // æ£€æŸ¥æ–°æ·»åŠ çš„èŠ‚ç‚¹æ˜¯å¦åŒ…å«è¡Œç¨‹å®¹å™¨
                    for (let i = 0; i < mutation.addedNodes.length; i++) {
                        const node = mutation.addedNodes[i];
                        if (node.nodeType === 1 && (
                            node.classList.contains('itinerary-container') || 
                            node.querySelector('.itinerary-container')
                        )) {
                            // å»¶è¿Ÿæ‰§è¡Œåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå·²å®Œå…¨æ›´æ–°
                            setTimeout(initItineraryUI, 300);
                            break;
                        }
                    }
                }
            });
        });
        
        // é…ç½®è§‚å¯Ÿå™¨
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // é¡µé¢åŠ è½½æ—¶ä¹Ÿåˆå§‹åŒ–ä¸€æ¬¡
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initItineraryUI, 300);
        });
    </script>
</body>
</html> 